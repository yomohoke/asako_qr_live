<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>LIVE AR RECOVERY</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: sans-serif; }
        /* スタート画面：絶対に最前面 */
        #start-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; color: #fff; z-index: 10000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        #start-button {
            padding: 20px 60px; font-size: 24px; font-weight: bold;
            background: #ff0000; color: #fff; border: none; border-radius: 50px;
        }
        /* 集中線（Manga FX）：CSSで作る絶対崩れない枠 */
        #manga-mask {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 500;
            background: radial-gradient(circle, transparent 40%, rgba(0,0,0,0.9) 150%);
            display: none; /* 認識するまで隠す */
        }
        /* ログ：状況確認用 */
        #log {
            position: fixed; top: 10px; left: 10px; color: #0f0; 
            font-size: 12px; z-index: 1001; background: rgba(0,0,0,0.5);
        }
    </style>
</head>

<body>
    <div id="log">Waiting for Start...</div>
    <div id="manga-mask"></div>

    <div id="start-screen">
        <h1 style="margin-bottom:10px;">LIVE AR</h1>
        <p style="margin-bottom:30px; opacity:0.7;">Sound On & Max Volume</p>
        <button id="start-button">START LIVE</button>
    </div>

    <a-scene 
        mindar-image="imageTargetSrc: ./targets.mind; uiLoading: no; uiScanning: no;" 
        embedded
        color-space="sRGB" 
        renderer="colorManagement: true, physicallyCorrectLights: true" 
        vr-mode-ui="enabled: false" 
        device-orientation-permission-ui="enabled: false">
        
        <a-assets>
            <a-asset-item id="bandModel" src="./scene.gltf"></a-asset-item>
            <audio id="bgm" src="./music.m4a" preload="auto" crossorigin="anonymous"></audio>
        </a-assets>

        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

        <a-entity id="target" mindar-image-target="targetIndex: 0">
            <a-entity id="model-entity" 
                gltf-model="#bandModel" 
                scale="1 1 1" 
                rotation="0 0 0" 
                visible="false">
            </a-entity>

            <a-circle id="wave" 
                color="#ff0000" 
                radius="0.6" 
                rotation="-90 0 0" 
                opacity="0.8" 
                visible="false">
            </a-circle>
        </a-entity>

        <a-light type="ambient" intensity="1"></a-light>
        <a-light type="directional" intensity="1.5" position="1 2 1"></a-light>
    </a-scene>

    <script>
        const logEl = document.getElementById('log');
        const startBtn = document.getElementById('start-button');
        const startScreen = document.getElementById('start-screen');
        const mask = document.getElementById('manga-mask');
        const audio = document.getElementById('bgm');
        const model = document.getElementById('model-entity');
        const wave = document.getElementById('wave');
        
        let isDetected = false;

        // 【Step 1】スタートボタン
        startBtn.addEventListener('click', () => {
            // iOSのオーディオロックを解除
            audio.play().then(() => {
                audio.pause(); // 鳴らしてすぐ止める（予約）
                audio.volume = 1;
                logEl.innerText = "READY: SCAN NEWSPAPER";
                startScreen.style.display = 'none';
            });
        });

        // 【Step 2】マーカー認識
        document.querySelector('#target').addEventListener("targetFound", () => {
            if (!isDetected) {
                isDetected = true;
                logEl.innerText = "LIVE START!";
                
                // 表示開始
                model.setAttribute('visible', true);
                wave.setAttribute('visible', true);
                mask.style.display = 'block';

                // 再生開始
                audio.play();
                startAudioAnalysis();
            }
        });

        // 【Step 3】オーディオリアクティブ（極限までシンプルに）
        function startAudioAnalysis() {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const src = ctx.createMediaElementSource(audio);
            const analyser = ctx.createAnalyser();
            analyser.fftSize = 128;
            src.connect(analyser);
            analyser.connect(ctx.destination);
            const data = new Uint8Array(analyser.frequencyBinCount);

            function update() {
                requestAnimationFrame(update);
                analyser.getByteFrequencyData(data);
                
                // 低音（キック）の強さを取得
                let volume = data[2] / 255; 

                if (volume > 0.4) {
                    let level = (volume - 0.4) * 2; // 増幅

                    // A. モデルをバウンドさせる
                    let s = 1 + (level * 0.3);
                    model.object3D.scale.set(s, s, s);

                    // B. 集中線（マスク）を動かす
                    // グラデーションの透明な穴を広げたり狭めたりする
                    let hole = 50 - (level * 20);
                    mask.style.background = `radial-gradient(circle, transparent ${hole}%, rgba(0,0,0,0.9) 150%)`;

                    // C. 波形を拡大
                    wave.setAttribute('scale', `${s} ${s} ${s}`);
                }
            }
            update();
        }
    </script>
</body>
</html>