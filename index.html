<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>WebAR - Live Experience</title>
    
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    
    <style>
      html, body {
        margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden;
        background-color: #000;
        transform: scale(1.03); transform-origin: center center;
        transition: transform 0.05s ease-out, filter 0.1s ease-out;
      }

      /* TAP TO START の画面 */
      #ui-layer {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: #111; z-index: 9999;
        display: flex; flex-direction: column; justify-content: center; align-items: center;
        color: white; font-family: sans-serif; transition: opacity 0.5s;
      }
      button {
        padding: 15px 40px; font-size: 1.2rem; background: transparent;
        color: white; border: 2px solid white; cursor: pointer; letter-spacing: 0.2em;
      }

      /* スキャン待機中の「暗転」オーバーレイ */
      #dark-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.85); /* 85%の黒 */
        z-index: 9000; pointer-events: none;
        display: none; justify-content: center; align-items: center;
        color: rgba(255,255,255,0.7); font-family: sans-serif; letter-spacing: 0.1em;
        transition: opacity 0.8s ease-out; /* じわっと明転・暗転させる */
      }
    </style>

    <script>
      // ▼ システム：オーディオ解析とCSSシェイク
      AFRAME.registerSystem('vj-controller', {
        init: function () {
          this.audio = null;
          this.analyser = null;
          this.dataArray = null;
          this.isPlaying = false;
          this.bodyEl = document.body;
        },

        // TAP TO START 時に呼ばれる（裏で音声を準備するだけ）
        setupAudio: function (audioId) {
          this.audio = document.querySelector(audioId);
          const AudioContext = window.AudioContext || window.webkitAudioContext;
          this.context = new AudioContext();
          
          const src = this.context.createMediaElementSource(this.audio);
          this.analyser = this.context.createAnalyser();
          this.analyser.fftSize = 256;
          
          src.connect(this.analyser);
          this.analyser.connect(this.context.destination);
          this.dataArray = new Uint8Array(this.analyser.frequencyBinCount);
          
          // iOSハック: ユーザーアクション内で一度playして即pause（再生権限の獲得）
          this.audio.play().then(() => {
            this.audio.pause();
            this.context.resume();
          }).catch(e => console.error("Audio Setup Error:", e));
        },

        // マーカー認識時に呼ばれる
        playLive: function () {
          if (this.audio) {
            this.audio.play();
            this.isPlaying = true;
          }
        },

        // マーカーを見失った時に呼ばれる
        pauseLive: function () {
          if (this.audio) {
            this.audio.pause();
            this.isPlaying = false;
            // 揺れを強制リセットしてピタッと止める
            this.bodyEl.style.transform = `translate(0px, 0px) scale(1.03)`;
            this.bodyEl.style.filter = `contrast(100%) saturate(100%)`;
          }
        },

        tick: function () {
          if (!this.isPlaying || !this.analyser) return;
          
          this.analyser.getByteFrequencyData(this.dataArray);
          
          let bassSum = 0;
          for(let i = 0; i < 5; i++) bassSum += this.dataArray[i];
          const bassVolume = bassSum / 5 / 255;

          // 【変更点】感度を 0.9 に引き上げ
          if (bassVolume > 0.9) {
            const shakeAmount = (bassVolume - 0.9) * 100; // 閾値が高い分、揺れ幅の倍率をアップ
            const x = (Math.random() - 0.5) * shakeAmount;
            const y = (Math.random() - 0.5) * shakeAmount;
            const scale = 1.03 + (bassVolume * 0.03); 
            
            this.bodyEl.style.transform = `translate(${x}px, ${y}px) scale(${scale})`;
            this.bodyEl.style.filter = `contrast(${100 + bassVolume * 50}%) saturate(${100 + bassVolume * 30}%)`;
          } else {
            this.bodyEl.style.transform = `translate(0px, 0px) scale(1.03)`;
            this.bodyEl.style.filter = `contrast(100%) saturate(100%)`;
          }
        }
      });

      // ▼ コンポーネント：マーカー認識のイベント検知
      AFRAME.registerComponent('target-events', {
        init: function () {
          const system = this.el.sceneEl.systems['vj-controller'];
          const darkOverlay = document.getElementById('dark-overlay');

          // マーカーを発見した時 ＝ 開演（明転・音楽スタート）
          this.el.addEventListener('targetFound', () => {
            darkOverlay.style.opacity = '0'; // じわっと明転
            system.playLive();
          });

          // マーカーを見失った時 ＝ 停止（暗転・音楽ストップ）
          this.el.addEventListener('targetLost', () => {
            darkOverlay.style.opacity = '1'; // じわっと暗転
            system.pauseLive();
          });
        }
      });

      // ▼ UIボタンの処理
      window.enterLive = function() {
        const uiLayer = document.getElementById('ui-layer');
        const darkOverlay = document.getElementById('dark-overlay');
        
        uiLayer.style.opacity = '0';
        setTimeout(() => uiLayer.style.display = 'none', 500);
        
        // 暗転レイヤーを表示（まだ opacity: 1 なので暗いまま）
        darkOverlay.style.display = 'flex';
        
        // オーディオの準備（ここではまだ鳴らない）
        document.querySelector('a-scene').systems['vj-controller'].setupAudio('#bgm');
      };
    </script>
  </head>
  <body>
    <div id="ui-layer">
      <button onclick="enterLive()">TAP TO START</button>
    </div>

    <div id="dark-overlay">
      新聞のQRコード周辺を映してください
    </div>

    <a-scene 
      mindar-image="imageTargetSrc: ./targets.mind; filterMinCF: 0.0001; filterBeta: 0.001;" 
      color-space="sRGB" renderer="colorManagement: true" 
      vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false">
      
      <a-assets>
        <audio id="bgm" src="./music.m4a" preload="auto" crossorigin="anonymous" loop></audio>
      </a-assets>

      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

      <a-entity mindar-image-target="targetIndex: 0" target-events>
        </a-entity>
    </a-scene>
  </body>
</html>