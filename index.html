<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>LIVE AR EXPERIENCE</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    
    <style>
      body { margin: 0; overflow: hidden; font-family: sans-serif; }
      
      /* å…¨ç”»é¢ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ (ã“ã‚Œã§ç¢ºå®Ÿã«éŸ³ã‚’å‡ºã•ã›ã‚‹) */
      #overlay {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.85); z-index: 9999;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        color: white; text-align: center;
      }
      #enter-btn {
        padding: 15px 40px; font-size: 18px; font-weight: bold; letter-spacing: 2px;
        background: white; color: black; border: none; cursor: pointer; margin-top: 20px;
      }
      
      /* ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ï¼ˆå‹•ä½œç¢ºèªç”¨ï¼‰ */
      #debug-log {
        position: absolute; top: 10px; left: 10px; color: yellow; z-index: 1000;
        background: rgba(0,0,0,0.5); padding: 5px; pointer-events: none;
        font-size: 12px;
      }
    </style>

    <script>
      // â–¼ ãƒ­ã‚°è¡¨ç¤ºç”¨
      function log(text) {
        const el = document.getElementById('debug-log');
        if(el) el.innerHTML = text;
        console.log(text);
      }

      // â–¼ ç´™é¢ã‚’æ­ªã¾ã›ã‚‹ã‚·ã‚§ãƒ¼ãƒ€ãƒ¼
      AFRAME.registerComponent('distorted-paper', {
        schema: {
          src: {type: 'map'}, 
        },
        init: function () {
          // â˜…ä¿®æ­£ãƒã‚¤ãƒ³ãƒˆ: æ–°èè¦‹é–‹ãï¼ˆ30æ®µï¼‰ã®æ¯”ç‡ã«åˆã‚ã›ã‚‹
          // æ¨ª764mm : ç¸¦514mm â‰’ 1 : 0.67
          const geometry = new THREE.PlaneGeometry(1, 0.67, 64, 64); 
          
          const texture = new THREE.TextureLoader().load(this.data.src.src); 
          
          const material = new THREE.ShaderMaterial({
            wireframe: false,
            transparent: true,
            uniforms: {
              uTime: { value: 0 },
              uAudio: { value: 0.0 },
              uTexture: { value: texture }
            },
            vertexShader: `
              varying vec2 vUv;
              uniform float uTime;
              uniform float uAudio;
              
              void main() {
                vUv = uv;
                vec3 pos = position;
                
                float d = distance(uv, vec2(0.5));
                float mask = smoothstep(0.5, 0.1, d); // ç«¯ã£ã“ã¯æºã‚‰ã•ãªã„
                
                // æºã‚Œã®è¨ˆç®—
                float wave = sin(pos.x * 10.0 + uTime * 6.0) * cos(pos.y * 10.0 + uTime * 5.0);
                
                // Zè»¸ï¼ˆé«˜ã•ï¼‰ã‚’å¤‰åŒ–ã•ã›ã‚‹
                pos.z += wave * uAudio * 0.3 * mask; 
                
                gl_Position = projectionMatrix * modelViewMatrix * vec4(pos, 1.0);
              }
            `,
            fragmentShader: `
              varying vec2 vUv;
              uniform sampler2D uTexture;
              uniform float uAudio;
              
              void main() {
                vec4 color = texture2D(uTexture, vUv);
                // éŸ³ã«åˆã‚ã›ã¦ç™ºå…‰
                color.rgb += uAudio * 0.3;
                gl_FragColor = color;
              }
            `
          });
          
          this.mesh = new THREE.Mesh(geometry, material);
          this.el.setObject3D('mesh', this.mesh);
        },
        
        tick: function (time, timeDelta) {
          if (!this.mesh) return;
          this.mesh.material.uniforms.uTime.value = time / 1000;
          // å¤–éƒ¨ã‹ã‚‰ä»£å…¥ã•ã‚ŒãŸã‚ªãƒ¼ãƒ‡ã‚£ã‚ªãƒ¬ãƒ™ãƒ«ã‚’åæ˜ 
          this.mesh.material.uniforms.uAudio.value = window.currentAudioLevel || 0;
        }
      });

      // â–¼ ãƒ¡ã‚¤ãƒ³åˆ¶å¾¡
      AFRAME.registerComponent('app-controller', {
        init: function () {
            this.audioEl = document.querySelector('#bgm');
            this.model = document.querySelector('#band-model');
            this.hasStarted = false;

            // ãƒãƒ¼ã‚«ãƒ¼èªè­˜ã‚¤ãƒ™ãƒ³ãƒˆ
            const scene = document.querySelector('a-scene');
            
            scene.addEventListener("targetFound", () => {
                log("Status: Target Found! ğŸ¯");
                if (window.isAudioUnlocked && !this.hasStarted) {
                    this.startShow();
                } else if (!window.isAudioUnlocked) {
                    log("Please tap Start button first");
                }
            });

            scene.addEventListener("targetLost", () => {
                log("Status: Searching... ğŸ”");
            });
        },

        startShow: function() {
            this.hasStarted = true;
            log("Status: SHOW START ğŸ¸");
            
            // éŸ³æ¥½å†ç”Ÿ
            this.audioEl.play();
            
            // ãƒ¢ãƒ‡ãƒ«å‡ºç¾ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
            this.model.setAttribute('visible', true);
            let s = 0;
            const timer = setInterval(() => {
                s += 0.05;
                this.model.setAttribute('scale', `${s} ${s} ${s}`);
                if (s >= 1.0) clearInterval(timer);
            }, 30);

            // ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªè§£æé–‹å§‹
            this.analyzeAudio();
        },

        analyzeAudio: function() {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            const ctx = new AudioContext();
            const src = ctx.createMediaElementSource(this.audioEl);
            const analyser = ctx.createAnalyser();
            analyser.fftSize = 256;
            src.connect(analyser);
            analyser.connect(ctx.destination);
            
            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            
            const loop = () => {
                requestAnimationFrame(loop);
                analyser.getByteFrequencyData(dataArray);
                let sum = 0;
                // ä½éŸ³åŸŸ(Bass)ã‚’å–å¾—
                for(let i=0; i<8; i++) sum += dataArray[i];
                let avg = sum / 8 / 255; 
                
                // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«å…¥ã‚Œã¦ã‚·ã‚§ãƒ¼ãƒ€ãƒ¼ã«æ¸¡ã™
                window.currentAudioLevel = avg;
                
                // æŒ¯å‹• (Android)
                if (avg > 0.6 && navigator.vibrate) navigator.vibrate(50);
            };
            loop();
        }
      });

      // â–¼ æœ€åˆã®ãƒœã‚¿ãƒ³æ“ä½œ
      window.onload = () => {
        document.getElementById('enter-btn').addEventListener('click', () => {
            // ã“ã“ã§AudioContextã‚’ä¸€åº¦è§¦ã£ã¦ãƒ­ãƒƒã‚¯è§£é™¤ã™ã‚‹
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            const ctx = new AudioContext();
            ctx.resume().then(() => {
                window.isAudioUnlocked = true;
                document.getElementById('overlay').style.display = 'none';
                log("Status: Ready to Scan! ğŸ“¸");
            });
        });
      };
    </script>
  </head>
  <body>
    <div id="overlay">
        <h1>LIVE AR</h1>
        <p>Turn on sound & Allow Camera</p>
        <button id="enter-btn">ENTER LIVE</button>
    </div>

    <div id="debug-log">Status: Initializing...</div>

    <a-scene 
      mindar-image="imageTargetSrc: ./targets.mind; uiScanning: no; filterMinCF:0.0001; filterBeta: 0.001;" 
      color-space="sRGB" 
      renderer="colorManagement: true, physicallyCorrectLights" 
      vr-mode-ui="enabled: false" 
      device-orientation-permission-ui="enabled: false">
      
      <a-assets>
        <a-asset-item id="modelAsset" src="./scene.gltf"></a-asset-item>
        <audio id="bgm" src="./music.m4a" preload="auto" crossorigin="anonymous"></audio>
        <img id="paperTex" src="./asako_qr_1.png" />
      </a-assets>

      <a-camera position="0 0 0" look-controls