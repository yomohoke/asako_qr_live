<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>LIVE AR - FINAL</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    
    <style>
      body { margin: 0; overflow: hidden; background: black; font-family: sans-serif; }
      
      /* ビデオタグ（背景）を動かすための設定 */
      video {
        transition: transform 0.1s cubic-bezier(0.1, 0.7, 1.0, 0.1); /* ビートに合う動き */
        transform-origin: center center;
      }

      /* MindARの標準UIを消す */
      .mindar-ui-loading, .mindar-ui-scanning { display: none !important; }

      /* スタート画面（最初から表示しておく） */
      #overlay {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: black; z-index: 99999;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        color: white; text-align: center;
      }
      
      #enter-btn {
        margin-top: 30px; padding: 20px 60px; 
        font-size: 24px; font-weight: 900; letter-spacing: 2px;
        background: white; color: black; border: none; cursor: pointer;
        clip-path: polygon(10% 0, 100% 0, 100% 70%, 90% 100%, 0 100%, 0 30%);
        text-transform: uppercase;
      }

      /* デバッグログ */
      #debug {
        position: absolute; top: 10px; left: 10px; 
        color: #00ff00; font-family: monospace; font-size: 12px; 
        background: rgba(0,0,0,0.5); pointer-events: none; z-index: 10000;
      }
    </style>

    <script>
      // ▼ エラー回避のためのログ関数
      function log(msg) {
        const d = document.getElementById('debug');
        if(d) d.innerText = msg;
        console.log(msg);
      }

      // ▼ 画質向上コンポーネント
      AFRAME.registerComponent('fix-quality', {
        init: function() {
            // iPhone等のRetinaディスプレイ対応
            this.el.sceneEl.renderer.setPixelRatio(window.devicePixelRatio);
        }
      });

      // ▼ メイン制御システム
      AFRAME.registerComponent('live-director', {
        init: function () {
            this.audioEl = document.querySelector('#bgm');
            this.model = document.querySelector('#band-model');
            this.effect = document.querySelector('#effect-group');
            this.videoEl = null; // まだ取得しない
            
            this.isPlaying = false;
            
            // シーンのイベント設定
            const scene = this.el.sceneEl;

            // AR準備完了時にビデオタグを取得（ここなら確実）
            scene.addEventListener("arReady", () => {
                log("Camera Ready. Waiting for Target...");
                this.videoEl = document.querySelector('video');
            });

            // マーカー認識
            scene.addEventListener("targetFound", () => {
                if (!window.audioUnlocked) {
                    log("TAP BUTTON FIRST!");
                    return;
                }
                if (!this.isPlaying) {
                    this.startSequence();
                }
            });
            
            scene.addEventListener("targetLost", () => {
                // ロストしても音楽は止めない（ライブ感重視）
                if(!this.isPlaying) log("Searching...");
            });
        },

        // 演出シーケンス
        startSequence: function() {
            this.isPlaying = true;
            log("Sequence: 1. GROWING");

            // ① モデル表示 & ニョキッ
            this.model.setAttribute('visible', true);
            let s = 0;
            const growTimer = setInterval(() => {
                s += 0.05;
                this.model.setAttribute('scale', `${s} ${s} ${s}`);
                if (s >= 1.0) clearInterval(growTimer);
            }, 20);

            // ② 0.6秒後にエフェクト展開
            setTimeout(() => {
                log("Sequence: 2. EFFECT SNAP");
                this.effect.setAttribute('visible', true);
            }, 600);

            // ③ 1.0秒後に音楽スタート & リアクティブ開始
            setTimeout(() => {
                log("Sequence: 3. MUSIC START!");
                this.audioEl.play();
                this.startReactivity();
            }, 1000);
        },

        // オーディオリアクティブ処理
        startReactivity: function() {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const src = ctx.createMediaElementSource(this.audioEl);
            const analyser = ctx.createAnalyser();
            analyser.fftSize = 512; // 解像度高め
            src.connect(analyser);
            analyser.connect(ctx.destination);
            
            const data = new Uint8Array(analyser.frequencyBinCount);
            
            const loop = () => {
                requestAnimationFrame(loop);
                analyser.getByteFrequencyData(data);

                // 低音 (Bass) を取得
                let bass = 0;
                for(let i=0; i<4; i++) bass += data[i];
                // 0.0 〜 1.0 に正規化
                let level = bass / 4 / 255;

                // しきい値カット (ノイズ無視)
                if (level < 0.4) level = 0;
                else level = (level - 0.4) * 2.5; // 残りを増幅

                // A. ビデオ画面自体のズーム (K-Pop風)
                // 音に合わせて 1.0倍 〜 1.3倍
                if (this.videoEl) {
                    const scale = 1.0 + (level * 0.3);
                    this.videoEl.style.transform = `scale(${scale})`;
                }

                // B. エフェクトの回転
                this.effect.object3D.rotation.z += 0.02 + (level * 0.1);

                // C. モデルのバウンス
                const mScale = 1.0 + (level * 0.2);
                this.model.object3D.scale.set(mScale, mScale, mScale);

                // D. バイブレーション (Androidのみ)
                if (level > 0.8 && navigator.vibrate) {
                    navigator.vibrate(30);
                }
            };
            loop();
        }
      });

      // ▼ 起動ボタンの処理 (window.onloadで確実に実行)
      window.onload = () => {
        const btn = document.getElementById('enter-btn');
        const overlay = document.getElementById('overlay');
        
        btn.addEventListener('click', () => {
            // オーディオコンテキストをアンロック
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            ctx.resume().then(() => {
                window.audioUnlocked = true;
                overlay.style.display = 'none'; // 画面を消す
                log("Status: Ready to Scan!");
            });
        });
      };
    </script>
  </head>
  <body>

    <div id="overlay">
        <h1 style="font-size:40px; margin:0; line-height:1;">LIVE<br><span style="color:red">AR</span></h1>
        <p style="font-size:14px; opacity:0.8; margin-top:10px;">VOLUME MAX RECOMMENDED</p>
        <button id="enter-btn">ENTER LIVE</button>
    </div>
    
    <div id="debug">INIT... (Waiting for Load)</div>

    <a-scene 
      fix-quality
      live-director
      mindar-image="imageTargetSrc: ./targets.mind; uiLoading: no; uiScanning: no; filterMinCF:0.0001; filterBeta: 0.001;" 
      color-space="sRGB" 
      renderer="colorManagement: true, physicallyCorrectLights: true; antialias: true;" 
      vr-mode-ui="enabled: false" 
      device-orientation-permission-ui="enabled: false">
      
      <a-assets>
        <a-asset-item id="modelAsset" src="./scene.gltf"></a-asset-item>
        <audio id="bgm" src="./music.m4a" preload="auto" crossorigin="anonymous"></audio>
      </a-assets>

      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

      <a-light type="ambient" intensity="0.5"></a-light>
      <a-light type="directional" intensity="2" position="1 2 1" color="#ff00aa"></a-light>
      <a-light type="point" intensity="1" position="-1 1 1" color="#00aaff"></a-light>

      <a-entity mindar-image-target="targetIndex: 0">
        
        <a-entity id="effect-group" visible="false">
             <a-ring color="#ff0055" radius-inner="0.6" radius-outer="0.65" opacity="0.8"></a-ring>
             <a-ring color="#ffffff" radius-inner="0.7" radius-outer="0.71" opacity="0.5"></a-ring>
             <a-entity rotation="0 0 0"><a-plane color="cyan" height="2" width="0.05" position="0 0 -0.01"></a-plane></a-entity>
             <a-entity rotation="0 0 90"><a-plane color="cyan" height="2" width="0.05" position="0 0 -0.01"></a-plane></a-entity>
        </a-entity>

        <a-entity id="band-model" 
                  gltf-model="#modelAsset" 
                  rotation="-90 180 0" 
                  position="0 0 0" 
                  scale="0 0 0" 
                  visible="false">
        </a-entity>
        
      </a-entity>
    </a-scene>
  </body>
</html>