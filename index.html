<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>LIVE AR - FINAL</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    
    <style>
      body { margin: 0; overflow: hidden; background: black; font-family: sans-serif; }
      
      /* 背景ビデオ（ここを揺らす） */
      video {
        transition: transform 0.05s linear; /* キビキビ動かす */
        transform-origin: center center;
      }

      /* UI除去 */
      .mindar-ui-loading, .mindar-ui-scanning { display: none !important; }

      /* スタート画面 */
      #overlay {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: black; z-index: 99999;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        color: white; text-align: center;
      }
      
      #enter-btn {
        margin-top: 20px; padding: 20px 60px; 
        font-size: 24px; font-weight: 900; background: white; color: black; border: none;
        clip-path: polygon(0 0, 100% 0, 100% 80%, 90% 100%, 0 100%);
      }

      /* 演出用テキスト */
      #live-text {
        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        color: red; font-size: 40px; font-weight: 900; 
        text-shadow: 2px 2px 0 #fff; z-index: 10000;
        display: none; /* 最初は隠す */
        pointer-events: none;
      }
    </style>

    <script>
      // ▼ 画質向上
      AFRAME.registerComponent('fix-quality', {
        init: function() {
            this.el.sceneEl.renderer.setPixelRatio(window.devicePixelRatio);
        }
      });

      // ▼ メイン制御
      AFRAME.registerComponent('live-director', {
        init: function () {
            this.audioEl = document.querySelector('#bgm');
            this.model = document.querySelector('#band-model');
            this.liveText = document.querySelector('#live-text');
            this.videoEl = null;
            this.isPlaying = false;
            
            const scene = this.el.sceneEl;
            const targetEntity = document.querySelector('#target-entity');

            // AR準備完了
            scene.addEventListener("arReady", () => {
                // ここでビデオタグを確実に捕まえる
                this.videoEl = document.querySelector('video');
                console.log("Video Element Found:", this.videoEl);
            });

            // ★ターゲット認識
            targetEntity.addEventListener("targetFound", () => {
                if (!this.isPlaying && window.audioUnlocked) {
                    this.startSequence();
                }
            });
            
            targetEntity.addEventListener("targetLost", () => {
                // ロストしても止めない（チラつき防止）
            });
        },

        startSequence: function() {
            this.isPlaying = true;

            // ① 視覚的に「始まった！」と出す
            this.liveText.style.display = 'block';
            this.liveText.innerText = "LIVE START!!";
            
            // 2秒後にテキストを消す
            setTimeout(() => { this.liveText.style.display = 'none'; }, 2000);

            // ② モデル表示
            this.model.setAttribute('visible', true);
            // アニメーション (scale 0 -> 1)
            let s = 0;
            const grow = setInterval(() => {
                s += 0.05;
                this.model.setAttribute('scale', `${s} ${s} ${s}`);
                if (s >= 1.0) clearInterval(grow);
            }, 30);

            // ③ 音楽再生（エラー対策付き）
            // ここでエラーが出ても、映像の処理は止めないようにPromiseで受ける
            this.audioEl.play()
                .then(() => {
                    console.log("Audio Playing");
                    this.startReactivity(); // 再生成功ならリアクティブ開始
                })
                .catch((e) => {
                    console.error("Audio Failed:", e);
                    this.liveText.innerText = "TAP SCREEN!"; // 失敗したらタップを促す
                    // 音が出なくても映像だけは動かすモードへ
                    this.startReactivity(true); 
                });
        },

        startReactivity: function(silentMode = false) {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            let analyser = null;
            let data = null;

            if (!silentMode) {
                const src = ctx.createMediaElementSource(this.audioEl);
                analyser = ctx.createAnalyser();
                analyser.fftSize = 512;
                src.connect(analyser);
                analyser.connect(ctx.destination);
                data = new Uint8Array(analyser.frequencyBinCount);
            }

            // ループ処理
            const loop = () => {
                requestAnimationFrame(loop);
                
                let level = 0;

                if (!silentMode && analyser) {
                    analyser.getByteFrequencyData(data);
                    let bass = 0;
                    // 低音 (Bass) 重視
                    for(let i=0; i<5; i++) bass += data[i];
                    level = bass / 5 / 255; // 0.0 ~ 1.0
                } else {
                    // ★サイレントモード（音が出ない時）の緊急措置
                    // 擬似的にビートを刻む（オートデモ）
                    const time = Date.now() / 1000;
                    level = (Math.sin(time * 10) + 1) * 0.3; // 勝手に揺らす
                }

                // 感度調整 (0.2以下はカット)
                if (level < 0.2) level = 0;
                else level = (level - 0.2) * 2.0;

                // --- 演出 ---

                // A. カメラ映像自体のズーム (K-Pop風)
                // 音に合わせて 1.0倍 〜 1.4倍
                if (this.videoEl) {
                    const scale = 1.0 + (level * 0.4);
                    this.videoEl.style.transform = `scale(${scale})`;
                }

                // B. モデルのバウンス & 回転
                const mScale = 1.0 + (level * 0.3);
                this.model.object3D.scale.set(mScale, mScale, mScale);
                this.model.object3D.rotation.y += 0.02 + (level * 0.05);

                // C. バイブレーション (Android)
                if (level > 0.7 && navigator.vibrate) {
                    navigator.vibrate(50);
                }
            };
            loop();
        }
      });

      window.onload = () => {
        const btn = document.getElementById('enter-btn');
        const overlay = document.getElementById('overlay');
        btn.addEventListener('click', () => {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            ctx.resume().then(() => {
                window.audioUnlocked = true;
                overlay.style.display = 'none';
            });
        });
      };
    </script>
  </head>
  <body>

    <div id="overlay">
        <h1>LIVE AR</h1>
        <p>VOLUME MAX</p>
        <button id="enter-btn">START</button>
    </div>

    <div id="live-text"></div>

    <a-scene 
      fix-quality
      live-director
      mindar-image="imageTargetSrc: ./targets.mind; uiLoading: no; uiScanning: no; filterMinCF:0.0001; filterBeta: 0.001;" 
      color-space="sRGB" 
      renderer="colorManagement: true, physicallyCorrectLights: true; antialias: true;" 
      vr-mode-ui="enabled: false" 
      device-orientation-permission-ui="enabled: false">
      
      <a-assets>
        <a-asset-item id="modelAsset" src="./scene.gltf"></a-asset-item>
        <audio id="bgm" src="./music.m4a" preload="auto" crossorigin="anonymous"></audio>
      </a-assets>

      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

      <a-light type="ambient" intensity="1"></a-light>
      <a-light type="directional" intensity="3" position="1 2 2" color="#ff0055"></a-light>

      <a-entity id="target-entity" mindar-image-target="targetIndex: 0">
        
        <a-entity id="band-model" 
                  gltf-model="#modelAsset" 
                  rotation="-90 180 0" 
                  position="0 0 0" 
                  scale="0 0 0" 
                  visible="false">
        </a-entity>
        
      </a-entity>
    </a-scene>
  </body>
</html>