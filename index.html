<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>WebAR - VJ Live Experience</title>
    
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    
    <style>
      html, body {
        margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden;
        background-color: #000;
        /* 回転や歪みで端の黒枠が見えないよう、ズーム率を少し上げました (1.03 -> 1.08) */
        transform: scale(1.08); 
        transform-origin: center center;
        /* 揺れの戻りを少し鋭く（VJっぽく）調整 */
        transition: transform 0.03s ease-out, filter 0.05s ease-out;
      }

      #ui-layer {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: #111; z-index: 9999;
        display: flex; flex-direction: column; justify-content: center; align-items: center;
        color: white; font-family: sans-serif; transition: opacity 0.5s;
      }
      button {
        padding: 15px 40px; font-size: 1.2rem; background: transparent;
        color: white; border: 2px solid white; cursor: pointer; letter-spacing: 0.2em;
      }

      #dark-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.9);
        z-index: 9000; pointer-events: none;
        display: none; justify-content: center; align-items: center;
        color: rgba(255,255,255,0.7); font-family: sans-serif; letter-spacing: 0.1em;
        transition: opacity 0.8s ease-out;
      }
    </style>

    <script>
      AFRAME.registerSystem('vj-controller', {
        init: function () {
          this.audio = null;
          this.analyser = null;
          this.dataArray = null;
          this.isPlaying = false;
          this.bodyEl = document.body;
          
          // RGB Shift用のSVGフィルター要素を取得
          this.offsetR = document.getElementById('offset-r');
          this.offsetG = document.getElementById('offset-g');
        },

        setupAudio: function (audioId) {
          this.audio = document.querySelector(audioId);
          const AudioContext = window.AudioContext || window.webkitAudioContext;
          this.context = new AudioContext();
          
          const src = this.context.createMediaElementSource(this.audio);
          this.analyser = this.context.createAnalyser();
          this.analyser.fftSize = 256;
          
          src.connect(this.analyser);
          this.analyser.connect(this.context.destination);
          this.dataArray = new Uint8Array(this.analyser.frequencyBinCount);
          
          // 【修正】音漏れ防止の完全ミュートハック
          this.audio.muted = true; // まずミュート
          this.audio.play().then(() => {
            this.audio.pause();
            this.audio.currentTime = 0;
            this.audio.muted = false; // 再生権限を得た後でミュート解除
            this.context.resume();
          }).catch(e => console.error("Audio Setup Error:", e));
        },

        playLive: function () {
          if (this.audio) {
            this.context.resume(); // 念のため再開
            this.audio.play();
            this.isPlaying = true;
          }
        },

        pauseLive: function () {
          if (this.audio) {
            this.audio.pause();
            this.isPlaying = false;
            
            // 揺れとエフェクトを強制リセット
            this.bodyEl.style.transform = `translate(0px, 0px) scale(1.08) rotate(0deg) skewX(0deg)`;
            this.bodyEl.style.filter = `none`;
            this.offsetR.setAttribute('dx', 0);
            this.offsetG.setAttribute('dx', 0);
          }
        },

        tick: function () {
          if (!this.isPlaying || !this.analyser) return;
          
          this.analyser.getByteFrequencyData(this.dataArray);
          
          let bassSum = 0;
          for(let i = 0; i < 5; i++) bassSum += this.dataArray[i];
          const bassVolume = bassSum / 5 / 255;

          // 感度0.9以上でエフェクト発動
          if (bassVolume > 0.9) {
            // --- 1. 過激なシェイク（Translate + Rotate + Skew） ---
            const intensity = (bassVolume - 0.9) * 10; // 強度係数
            
            const x = (Math.random() - 0.5) * 80 * intensity;  // 激しい横揺れ
            const y = (Math.random() - 0.5) * 80 * intensity;  // 激しい縦揺れ
            const angle = (Math.random() - 0.5) * 6 * intensity; // ±3度の回転（画面が傾く）
            const skew = (Math.random() - 0.5) * 10 * intensity; // ±5度の歪み（Fragment的）
            const scale = 1.08 + (bassVolume * 0.05); // ズームイン
            
            this.bodyEl.style.transform = `translate(${x}px, ${y}px) scale(${scale}) rotate(${angle}deg) skewX(${skew}deg)`;
            
            // --- 2. RGB Shift (色収差) の適用 ---
            const rgbShiftAmount = intensity * 15; // 左右に最大15px程度ズレる
            this.offsetR.setAttribute('dx', rgbShiftAmount);
            this.offsetG.setAttribute('dx', -rgbShiftAmount); // Gは逆方向へ
            
            // コントラストも爆上げしてチカチカさせる
            this.bodyEl.style.filter = `contrast(150%) brightness(120%) url(#rgb-shift)`;

          } else {
            // 低音が無い時はスッと元に戻す
            this.bodyEl.style.transform = `translate(0px, 0px) scale(1.08) rotate(0deg) skewX(0deg)`;
            this.bodyEl.style.filter = `none`; // フィルターを外して軽くする
            this.offsetR.setAttribute('dx', 0);
            this.offsetG.setAttribute('dx', 0);
          }
        }
      });

      AFRAME.registerComponent('target-events', {
        init: function () {
          const system = this.el.sceneEl.systems['vj-controller'];
          const darkOverlay = document.getElementById('dark-overlay');

          this.el.addEventListener('targetFound', () => {
            darkOverlay.style.opacity = '0';
            system.playLive();
          });

          this.el.addEventListener('targetLost', () => {
            darkOverlay.style.opacity = '1';
            system.pauseLive();
          });
        }
      });

      window.enterLive = function() {
        const uiLayer = document.getElementById('ui-layer');
        const darkOverlay = document.getElementById('dark-overlay');
        
        uiLayer.style.opacity = '0';
        setTimeout(() => uiLayer.style.display = 'none', 500);
        
        darkOverlay.style.display = 'flex';
        document.querySelector('a-scene').systems['vj-controller'].setupAudio('#bgm');
      };
    </script>
  </head>
  <body>

    <svg style="width:0; height:0; position:absolute;">
      <defs>
        <filter id="rgb-shift">
          <feColorMatrix type="matrix" values="1 0 0 0 0  0 0 0 0 0  0 0 0 0 0  0 0 0 1 0" in="SourceGraphic" result="RED"/>
          <feOffset id="offset-r" dx="0" dy="0" in="RED" result="RED_SHIFTED"/>
          
          <feColorMatrix type="matrix" values="0 0 0 0 0  0 1 0 0 0  0 0 0 0 0  0 0 0 1 0" in="SourceGraphic" result="GREEN"/>
          <feOffset id="offset-g" dx="0" dy="0" in="GREEN" result="GREEN_SHIFTED"/>
          
          <feColorMatrix type="matrix" values="0 0 0 0 0  0 0 0 0 0  0 0 1 0 0  0 0 0 1 0" in="SourceGraphic" result="BLUE"/>
          
          <feBlend mode="screen" in="RED_SHIFTED" in2="GREEN_SHIFTED" result="RG"/>
          <feBlend mode="screen" in="RG" in2="BLUE" result="RGB"/>
        </filter>
      </defs>
    </svg>

    <div id="ui-layer">
      <button onclick="enterLive()">TAP TO START</button>
    </div>

    <div id="dark-overlay">
      新聞のQRコード周辺を映してください
    </div>

    <a-scene 
      mindar-image="imageTargetSrc: ./targets.mind; filterMinCF: 0.0001; filterBeta: 0.001;" 
      color-space="sRGB" renderer="colorManagement: true" 
      vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false">
      
      <a-assets>
        <audio id="bgm" src="./music.m4a" preload="auto" crossorigin="anonymous" loop></audio>
      </a-assets>

      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

      <a-entity mindar-image-target="targetIndex: 0" target-events>
        <a-plane position="0 0 0" width="1" height="1.4" color="#ff0044" opacity="0.3" transparent="true"></a-plane>
      </a-entity>
    </a-scene>
  </body>
</html>