<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>WebAR Live Experience - Asahi Advertising Award</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    
    <style>
      /* 賞を狙うための高級感あるUI */
      #overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: radial-gradient(circle, #222 0%, #000 100%);
        color: white; display: flex; flex-direction: column;
        justify-content: center; align-items: center; z-index: 9999;
        transition: opacity 0.8s ease; font-family: sans-serif;
      }
      #start-btn {
        padding: 20px 40px; border: 2px solid #fff; background: transparent;
        color: white; font-size: 1.2rem; letter-spacing: 0.2em;
        cursor: pointer; transition: 0.3s;
      }
      #start-btn:active { background: white; color: black; }
      .loading-text { margin-top: 20px; font-size: 0.8rem; opacity: 0.6; }
      #ar-ui { position: fixed; bottom: 30px; width: 100%; text-align: center; color: white; z-index: 10; pointer-events: none; text-shadow: 0 0 10px #000; }
    </style>

    <script>
      // 1. オーディオ解析システム（全ての演出の心臓部）
      AFRAME.registerSystem('audio-analyzer', {
        init: function () {
          this.analyser = null;
          this.dataArray = null;
          this.bass = 0;
          this.isReady = false;
        },
        setup: function (audioElement) {
          const AudioContext = window.AudioContext || window.webkitAudioContext;
          this.context = new AudioContext();
          const source = this.context.createMediaElementSource(audioElement);
          this.analyser = this.context.createAnalyser();
          this.analyser.fftSize = 256;
          source.connect(this.analyser);
          this.analyser.connect(this.context.destination);
          this.dataArray = new Uint8Array(this.analyser.frequencyBinCount);
          this.isReady = true;
        },
        tick: function () {
          if (!this.isReady) return;
          this.analyser.getByteFrequencyData(this.dataArray);
          
          // 低音域（Bass）の平均を計算 (0.0 - 1.0)
          let sum = 0;
          for (let i = 0; i < 8; i++) sum += this.dataArray[i];
          let targetBass = sum / 8 / 255;
          // スムージング処理
          this.bass += (targetBass - this.bass) * 0.2;

          // 振動（Androidのみ / 低音が一定値を超えたら発動）
          if (targetBass > 0.6 && Math.random() > 0.8) {
            if (navigator.vibrate) navigator.vibrate(20);
          }
        }
      });

      // 2. カメラ・シェイク演出
      AFRAME.registerComponent('cam-fx', {
        tick: function () {
          const bass = this.el.sceneEl.systems['audio-analyzer'].bass;
          if (bass > 0.1) {
            // 微細な振動とズーム
            const shake = bass * 0.05;
            this.el.setAttribute('position', `${(Math.random()-0.5)*shake} ${0.1 + (Math.random()-0.5)*shake} 0`);
            // 画角（FOV）を音圧で変える（ライブの迫力）
            this.el.getObject3D('camera').fov = 80 + (bass * 15);
            this.el.getObject3D('camera').updateProjectionMatrix();
          }
        }
      });

      // 3. TouchDesigner風プロシージャル・メッシュ
      AFRAME.registerComponent('audio-reactive-mesh', {
        init: function () {
          const geo = new THREE.IcosahedronGeometry(0.8, 4); // 球体ベースの複雑な形状
          const mat = new THREE.ShaderMaterial({
            wireframe: true,
            transparent: true,
            uniforms: {
              uTime: { value: 0 },
              uAudio: { value: 0 }
            },
            vertexShader: `
              varying vec2 vUv;
              uniform float uTime;
              uniform float uAudio;
              void main() {
                vUv = uv;
                vec3 pos = position;
                // ノイズ的なうねり（プロシージャル）
                float noise = sin(pos.x * 5.0 + uTime) * cos(pos.y * 5.0 + uTime);
                pos += normal * noise * uAudio * 0.5;
                gl_Position = projectionMatrix * modelViewMatrix * vec4(pos, 1.0);
              }
            `,
            fragmentShader: `
              varying vec2 vUv;
              uniform float uAudio;
              void main() {
                // 音圧で色をシアンからマゼンタへ
                vec3 color = mix(vec3(0.1, 0.8, 1.0), vec3(1.0, 0.0, 0.5), uAudio);
                gl_FragColor = vec4(color, 0.7);
              }
            `
          });
          this.mesh = new THREE.Mesh(geo, mat);
          this.el.setObject3D('mesh', this.mesh);
        },
        tick: function (time) {
          const bass = this.el.sceneEl.systems['audio-analyzer'].bass;
          this.mesh.material.uniforms.uTime.value = time / 1000;
          this.mesh.material.uniforms.uAudio.value = bass;
          this.el.setAttribute('rotation', `0 ${time / 50} 0`);
        }
      });

      // 4. スタートシーケンス制御
      window.startLive = function() {
        const overlay = document.querySelector('#overlay');
        const audio = document.querySelector('#bgm');
        
        overlay.style.opacity = '0';
        setTimeout(() => overlay.remove(), 800);

        // iOS対策: ユーザー操作直後にAudioContextを開始
        const system = document.querySelector('a-scene').systems['audio-analyzer'];
        system.setup(audio);
        audio.play();
      };
    </script>
  </head>

  <body>
    <div id="overlay">
      <button id="start-btn" onclick="startLive()">ENTER LIVE</button>
      <div class="loading-text">新聞をステージに変える体験。</div>
    </div>

    <div id="ar-ui">新聞の広告面を映してください</div>

    <a-scene 
      mindar-image="imageTargetSrc: ./targets.mind; autoStart: true;" 
      renderer="colorManagement: true, physicallyCorrectLights: true"
      vr-mode-ui="enabled: false"
      device-orientation-permission-ui="enabled: false">
      
      <a-assets>
        <a-asset-item id="avatarModel" src="./scene.gltf"></a-asset-item>
        <audio id="bgm" src="./music.m4a" crossorigin="anonymous" loop></audio>
      </a-assets>

      <a-camera cam-fx position="0 0.1 0" look-controls="enabled: false"></a-camera>

      <a-entity mindar-image-target="targetIndex: 0">
        <a-entity audio-reactive-mesh position="0 0 -0.1"></a-entity>

        <a-gltf-model 
          src="#avatarModel" 
          position="0 -0.5 0.1" 
          rotation="90 0 0" 
          scale="0 0 0"
          animation__show="property: scale; to: 1 1 1; dur: 1500; easing: easeOutElastic; startEvents: targetFound"
          animation__bounce="property: position; to: 0 -0.45 0.1; dir: alternate; dur: 200; loop: true; easing: easeInOutSine; startEvents: targetFound">
        </a-gltf-model>

        <a-light type="spot" color="#fff" intensity="2" position="0 2 2" target="a-gltf-model"></a-light>
      </a-entity>
    </a-scene>
  </body>
</html>