<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>LIVE AR - VIBE CHECK</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    
    <style>
      body { margin: 0; overflow: hidden; font-family: sans-serif; background: black;}
      
      /* UI除去 */
      .mindar-ui-loading, .mindar-ui-scanning { display: none !important; }

      /* スタート画面 */
      #overlay {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: black; z-index: 99999;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        color: white; text-align: center;
      }
      #enter-btn {
        padding: 15px 40px; font-size: 24px; font-weight: 900; letter-spacing: 4px;
        background: white; color: black; border: none; cursor: pointer; margin-top: 30px;
        text-transform: uppercase; clip-path: polygon(10% 0, 100% 0, 100% 70%, 90% 100%, 0 100%, 0 30%);
      }
      #status { position: absolute; top:10px; left:10px; color:#0f0; font-family:monospace; font-size:10px; z-index:1000; pointer-events:none;}
    </style>

    <script>
      // ▼ オーディオリアクティブ・エフェクト（足元の演出）
      AFRAME.registerComponent('audio-ring', {
        init: function () {
          // リング状のメッシュを作成
          const geometry = new THREE.RingGeometry(0.3, 0.35, 32);
          const material = new THREE.MeshBasicMaterial({ color: 0xff0000, transparent: true, opacity: 0.5, side: THREE.DoubleSide });
          this.mesh = new THREE.Mesh(geometry, material);
          this.el.setObject3D('mesh', this.mesh);
        },
        tick: function () {
          if (!this.mesh) return;
          // 音量に合わせてリングが拡大縮小＆明滅
          const level = window.currentAudioLevel || 0;
          const scale = 1 + level * 2.0; // 結構派手に動かす
          this.mesh.scale.set(scale, scale, 1);
          this.mesh.material.opacity = 0.2 + level * 0.8;
        }
      });

      // ▼ 【重要】カメラワーク制御（K-Pop風ズーム）
      AFRAME.registerComponent('beat-camera', {
        init: function() {
            this.camera = this.el;
            this.baseZoom = 1.0;
        },
        tick: function() {
            const level = window.currentAudioLevel || 0;
            
            // 音が大きいとき、カメラのZoom値をいじる
            // 1.0 (通常) 〜 1.4 (最大ズーム)
            // 閾値(0.1)以下のノイズは無視
            let targetZoom = 1.0;
            if (level > 0.1) {
                targetZoom = 1.0 + (level * 0.6); 
            }

            // 滑らかに追従させる（Lerp）
            // 数値を大きくするとビビッドに、小さくするとヌルッと動く
            this.camera.setAttribute('camera', 'zoom', 
                this.camera.components.camera.data.zoom * 0.8 + targetZoom * 0.2
            );

            // さらに振動（手ブレ）を加える
            if (level > 0.4) {
                const shake = (Math.random() - 0.5) * 0.05 * level;
                this.camera.object3D.position.x = shake;
            } else {
                this.camera.object3D.position.x = 0;
            }
        }
      });

      // ▼ アプリ制御
      AFRAME.registerComponent('app-controller', {
        init: function () {
            this.audioEl = document.querySelector('#bgm');
            this.model = document.querySelector('#band-model');
            this.ring = document.querySelector('#effect-ring');
            this.hasStarted = false;

            const scene = document.querySelector('a-scene');
            
            scene.addEventListener("targetFound", () => {
                if (window.isAudioUnlocked && !this.hasStarted) {
                    this.startShow();
                } else if(!window.isAudioUnlocked) {
                    document.getElementById('status').innerText = "TAP BUTTON FIRST!";
                }
            });
        },

        startShow: function() {
            this.hasStarted = true;
            document.getElementById('status').innerText = "LIVE ON AIR";
            
            this.audioEl.play();
            
            // モデル出現アニメーション
            this.model.setAttribute('visible', true);
            this.ring.setAttribute('visible', true);
            
            let s = 0;
            const timer = setInterval(() => {
                s += 0.05;
                // モデルのスケール
                this.model.setAttribute('scale', `${s} ${s} ${s}`);
                if (s >= 1.0) clearInterval(timer);
            }, 20); // 少し高速に

            this.analyzeAudio();
        },

        analyzeAudio: function() {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const src = ctx.createMediaElementSource(this.audioEl);
            const analyser = ctx.createAnalyser();
            analyser.fftSize = 256;
            src.connect(analyser);
            analyser.connect(ctx.destination);
            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            
            const loop = () => {
                requestAnimationFrame(loop);
                analyser.getByteFrequencyData(dataArray);
                let sum = 0;
                // 低音域重視
                for(let i=0; i<6; i++) sum += dataArray[i]; 
                window.currentAudioLevel = (sum / 6 / 255); // 0.0 ~ 1.0
                
                // Androidバイブレーション（強め）
                if (window.currentAudioLevel > 0.5 && navigator.vibrate) {
                    navigator.vibrate(40);
                }
            };
            loop();
        }
      });

      window.onload = () => {
        document.getElementById('enter-btn').addEventListener('click', () => {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            ctx.resume().then(() => {
                window.isAudioUnlocked = true;
                document.getElementById('overlay').style.display = 'none';
                document.getElementById('status').innerText = "SCAN TARGET";
            });
        });
      };
    </script>
  </head>
  <body>

    <div id="overlay">
        <h1 style="font-size:40px; margin:0; line-height:1;">LIVE<br><span style="color:red">AR</span></h1>
        <p style="font-size:12px; opacity:0.7;">VOLUME MAX RECOMMENDED</p>
        <button id="enter-btn">ENTER</button>
    </div>
    <div id="status">INIT...</div>

    <a-scene 
      mindar-image="imageTargetSrc: ./targets.mind; uiLoading: no; uiScanning: no; filterMinCF:0.0001; filterBeta: 0.001;" 
      color-space="sRGB" 
      renderer="colorManagement: true, physicallyCorrectLights: true; antialias: true; highRefreshRate: true;" 
      vr-mode-ui="enabled: false" 
      device-orientation-permission-ui="enabled: false">
      
      <a-assets>
        <a-asset-item id="modelAsset" src="./scene.gltf"></a-asset-item>
        <audio id="bgm" src="./music.m4a" preload="auto" crossorigin="anonymous"></audio>
      </a-assets>

      <a-camera position="0 0 0" look-controls="enabled: false" beat-camera></a-camera>
      
      <a-entity app-controller></a-entity>

      <a-light type="ambient" intensity="0.5"></a-light>
      <a-light type="spot" intensity="10" position="0 5 2" angle="30" penumbra="1" color="#ff0055"></a-light>
      <a-light type="point" intensity="5" position="-2 2 2" color="#00aaff"></a-light>

      <a-entity mindar-image-target="targetIndex: 0">
        
        <a-entity id="effect-ring" audio-ring position="0 0 0.01" visible="false"></a-entity>
        
        <a-entity id="band-model" 
                  gltf-model="#modelAsset" 
                  rotation="-90 180 0" 
                  position="0 0 0" 
                  scale="0 0 0" 
                  visible="false">
        </a-entity>
        
      </a-entity>
    </a-scene>
  </body>
</html>