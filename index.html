<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>LIVE AR - FIXED</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    
    <style>
      body { margin: 0; overflow: hidden; background: black; font-family: monospace; }
      
      video {
        transition: transform 0.1s ease-out; 
        transform-origin: center center;
      }

      .mindar-ui-loading, .mindar-ui-scanning { display: none !important; }

      #overlay {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: black; z-index: 99999;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        color: white; text-align: center;
      }
      
      #enter-btn {
        margin-top: 20px; padding: 20px 50px; 
        font-size: 20px; font-weight: bold; background: white; color: black; border: none;
      }

      /* デバッグログ（エラーは赤く出る） */
      #debug-console {
        position: absolute; top: 0; left: 0; width: 100%;
        background: rgba(0,0,0,0.7); color: lime; 
        padding: 5px; font-size: 14px; pointer-events: none; z-index: 10000;
        white-space: pre-wrap; 
      }
      .error-msg { color: red; font-weight: bold; background: white; }
    </style>

    <script>
      function log(msg, isError = false) {
        const d = document.getElementById('debug-console');
        if(d) {
            if(isError) d.innerHTML += "\n<span class='error-msg'>" + msg + "</span>";
            else d.innerText += "\n" + msg;
        }
        console.log(msg);
      }

      AFRAME.registerComponent('live-director', {
        init: function () {
            log("[1] System Init");
            
            // ★重要：ここで「自分」を変数 me に保存して固定する！
            let me = this;

            me.audioEl = document.querySelector('#bgm');
            me.model = document.querySelector('#band-model');
            me.videoEl = null;
            me.isPlaying = false;
            
            const scene = me.el.sceneEl;
            const targetEntity = document.querySelector('#target-entity');

            scene.addEventListener("arReady", () => {
                log("[2] AR Ready");
                me.videoEl = document.querySelector('video');
                if(me.videoEl) log("-> Video Found");
            });

            targetEntity.addEventListener("targetFound", () => {
                log("[3] Target FOUND!");
                
                // ★ここからエラーが起きても止まらないように監視する
                try {
                    if (!me.isPlaying) {
                        log("-> Calling Start...");
                        // me を使って呼び出す
                        me.startSequence(); 
                    } else {
                        log("-> Already Playing");
                    }
                } catch(e) {
                    // ★もしエラーなら画面に赤字で出す！
                    log("CRASH: " + e.message, true);
                }
            });
        },

        startSequence: function() {
            // ここでも me ではなく this を使う（呼び出されれば this は正しい）
            // 安全のため try-catch
            try {
                this.isPlaying = true;
                log("[4] Sequence Started");

                // ① モデル表示
                this.model.setAttribute('visible', true);
                this.model.setAttribute('scale', '1 1 1');
                log("-> Model ON");

                // ② 音楽再生
                log("[5] Audio Play...");
                this.audioEl.play()
                    .then(() => {
                        log("[6] Audio OK! Loop Start");
                        this.startReactivity(); 
                    })
                    .catch((e) => {
                        log("[!] Audio Blocked: " + e.message, true);
                        log("-> Force Visuals");
                        this.startReactivity(true);
                    });

            } catch(e) {
                log("SEQ ERROR: " + e.message, true);
            }
        },

        startReactivity: function(silentMode = false) {
            log("[7] Reactive Loop");
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            let analyser = null;
            let data = null;

            if (!silentMode) {
                try {
                    const src = ctx.createMediaElementSource(this.audioEl);
                    analyser = ctx.createAnalyser();
                    analyser.fftSize = 512;
                    src.connect(analyser);
                    analyser.connect(ctx.destination);
                    data = new Uint8Array(analyser.frequencyBinCount);
                } catch(e) {
                    log("AudioCtx Error: " + e);
                }
            }

            // this のスコープが外れるので、ここでも変数に入れる
            let that = this;

            const loop = () => {
                requestAnimationFrame(loop);
                
                let level = 0;
                if (!silentMode && analyser && data) {
                    analyser.getByteFrequencyData(data);
                    let bass = 0;
                    for(let i=0; i<5; i++) bass += data[i];
                    level = bass / 5 / 255; 
                } else {
                    level = (Math.sin(Date.now() / 150) + 1) * 0.4; // オートデモ
                }

                if (level < 0.2) level = 0;
                else level = (level - 0.2) * 2.0;

                // 映像ズーム
                if (that.videoEl) {
                    const scale = 1.0 + (level * 0.4);
                    that.videoEl.style.transform = `scale(${scale})`;
                }
                
                // モデル
                if(that.model) {
                    that.model.object3D.rotation.y += 0.03;
                    const s = 1.0 + (level * 0.3);
                    that.model.object3D.scale.set(s, s, s);
                }
            };
            loop();
        }
      });

      window.onload = () => {
        const btn = document.getElementById('enter-btn');
        btn.addEventListener('click', () => {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            ctx.resume().then(() => {
                document.getElementById('overlay').style.display = 'none';
            });
        });
      };
    </script>
  </head>
  <body>

    <div id="overlay">
        <h1>FIXED MODE</h1>
        <button id="enter-btn">START</button>
    </div>

    <div id="debug-console">Waiting...</div>

    <a-scene 
      live-director
      mindar-image="imageTargetSrc: ./targets.mind; uiLoading: no; uiScanning: no; filterMinCF:0.0001; filterBeta: 0.001;" 
      color-space="sRGB" 
      renderer="colorManagement: true, physicallyCorrectLights: true;" 
      vr-mode-ui="enabled: false" 
      device-orientation-permission-ui="enabled: false">
      
      <a-assets>
        <a-asset-item id="modelAsset" src="./scene.gltf"></a-asset-item>
        <audio id="bgm" src="./music.m4a" preload="auto" crossorigin="anonymous"></audio>
      </a-assets>

      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

      <a-light type="ambient" intensity="1"></a-light>
      <a-light type="directional" intensity="3" position="1 2 2"></a-light>

      <a-entity id="target-entity" mindar-image-target="targetIndex: 0">
        
        <a-box color="red" position="0 0.5 0" scale="0.1 0.1 0.1"></a-box>

        <a-entity id="band-model" 
                  gltf-model="#modelAsset" 
                  rotation="-90 180 0" 
                  position="0 0 0" 
                  scale="0 0 0" 
                  visible="false">
        </a-entity>
        
      </a-entity>
    </a-scene>
  </body>
</html>