<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>LIVE AR - EXTREME</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    
    <style>
      body { margin: 0; overflow: hidden; background: black; }
      
      /* 映像を揺らすためにvideoタグにアクセスしやすくする */
      video {
        transition: transform 0.05s linear; /* キビキビ動くように調整 */
        transform-origin: center center;
      }

      /* UI除去 */
      .mindar-ui-loading, .mindar-ui-scanning { display: none !important; }

      /* スタート画面 */
      #overlay {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: black; z-index: 99999;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        color: white; text-align: center;
      }
      #enter-btn {
        padding: 20px 50px; font-size: 20px; font-weight: 900; background: white; color: black; border: none;
        clip-path: polygon(0 0, 100% 0, 100% 70%, 85% 100%, 0 100%);
      }
      /* デバッグ用：ちゃんと数値が取れてるか確認 */
      #debug {
        position: absolute; top: 10px; left: 10px; color: #0f0; font-family: monospace; font-size: 14px; z-index: 10000;
        text-shadow: 1px 1px 0 #000;
      }
    </style>

    <script>
      // ▼ オーディオ解析＆映像ハック
      AFRAME.registerComponent('audio-reactive-core', {
        init: function () {
            this.audioEl = document.querySelector('#bgm');
            this.videoEl = null; // 後で取得
            this.model = document.querySelector('#band-model');
            this.effect = document.querySelector('#effect-plane');
            this.debug = document.getElementById('debug');
            
            this.isPlaying = false;
            this.analyser = null;
            this.dataArray = null;

            // マーカー認識時のシーケンス制御
            const scene = document.querySelector('a-scene');
            
            // MindARのビデオ要素を取得（ここを揺らす！）
            scene.addEventListener("arReady", () => {
                this.videoEl = document.querySelector('video');
            });

            scene.addEventListener("targetFound", () => {
                if (window.isAudioUnlocked && !this.isPlaying) {
                    this.runSequence();
                } else if(!window.isAudioUnlocked) {
                    this.debug.innerText = "TAP BUTTON FIRST!";
                }
            });
        },

        runSequence: function() {
            this.isPlaying = true;
            this.debug.innerText = "SEQ: 1. GROWING...";

            // ① モデル表示＆ニョキッと生える (0.5秒)
            this.model.setAttribute('visible', true);
            this.model.setAttribute('animation', 'property: scale; from: 0 0 0; to: 1 1 1; dur: 800; easing: easeOutElastic;');

            // ② エフェクトがシュンッ！と展開 (モデルの後、0.8秒後)
            setTimeout(() => {
                this.debug.innerText = "SEQ: 2. EFFECT SNAP!";
                this.effect.setAttribute('visible', true);
                // スケールを一気に広げるアニメーション
                this.effect.setAttribute('animation', 'property: scale; from: 0 0 0; to: 1.5 1.5 1.5; dur: 300; easing: easeOutExpo;');
            }, 800);

            // ③ 音楽スタート＆リアクティブ開始 (1.2秒後)
            setTimeout(() => {
                this.debug.innerText = "SEQ: 3. MUSIC START & VIBE!!";
                this.audioEl.play();
                this.startReactiveLoop();
            }, 1200);
        },

        startReactiveLoop: function() {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const src = ctx.createMediaElementSource(this.audioEl);
            const analyser = ctx.createAnalyser();
            analyser.fftSize = 256; // 解像度
            analyser.smoothingTimeConstant = 0.3; // 反応をキビキビさせる（デフォルト0.8だと遅い）
            src.connect(analyser);
            analyser.connect(ctx.destination);
            
            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            
            const render = () => {
                requestAnimationFrame(render);
                analyser.getByteFrequencyData(dataArray);

                // 低音域（Bass）をガッツリ取る
                let sum = 0;
                // 0~5番目の周波数（超低音）だけを見る
                for(let i=0; i<5; i++) sum += dataArray[i];
                
                // 平均値 (0.0 ~ 1.0)
                // ★感度調整: 小さい音は切り捨て、大きい音を強調
                let rawAvg = sum / 5 / 255; 
                let level = 0;
                
                // しきい値（Threshold）: 0.3以下の音は無視（0にする）
                if (rawAvg > 0.3) {
                    level = (rawAvg - 0.3) * 2.0; // 残りを増幅
                }

                // デバッグ表示
                // this.debug.innerText = `LEVEL: ${level.toFixed(2)}`;

                // --- 演出への反映 ---

                // 1. ビデオ背景自体のズーム（K-Pop風）
                // 音がないときは 1.0、音があるときは最大 1.2倍
                if (this.videoEl) {
                    const zoom = 1.0 + (level * 0.15); 
                    this.videoEl.style.transform = `scale(${zoom})`;
                }

                // 2. モデルのサイズ（ベースサイズほぼ0 + 音量）
                // 音がないと 0.2、音で 1.5 まで巨大化
                const modelScale = 0.2 + (level * 1.3);
                this.model.object3D.scale.set(modelScale, modelScale, modelScale);

                // 3. エフェクト（グリッド）の回転
                this.effect.object3D.rotation.z += 0.01 + (level * 0.1);

                // 4. Androidバイブレーション
                if (level > 0.8 && navigator.vibrate) {
                    navigator.vibrate(30);
                }
            };
            render();
        }
      });

      window.onload = () => {
        document.getElementById('enter-btn').addEventListener('click', () => {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            ctx.resume().then(() => {
                window.isAudioUnlocked = true;
                document.getElementById('overlay').style.display = 'none';
            });
        });
      };
    </script>
  </head>
  <body>

    <div id="overlay">
        <h1>LIVE AR</h1>
        <p>SOUND ON / MAX VOL</p>
        <button id="enter-btn">ENTER LIVE</button>
    </div>
    <div id="debug">INIT...</div>

    <a-scene 
      mindar-image="imageTargetSrc: ./targets.mind; uiLoading: no; uiScanning: no; filterMinCF:0.0001; filterBeta: 0.001;" 
      color-space="sRGB" 
      renderer="colorManagement: true, physicallyCorrectLights: true;" 
      vr-mode-ui="enabled: false" 
      device-orientation-permission-ui="enabled: false">
      
      <a-assets>
        <a-asset-item id="modelAsset" src="./scene.gltf"></a-asset-item>
        <audio id="bgm" src="./music.m4a" preload="auto" crossorigin="anonymous"></audio>
        <img id="gridTex" src="./target.png" />
      </a-assets>

      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
      
      <a-entity audio-reactive-core></a-entity>

      <a-light type="directional" intensity="3" position="2 4 2" color="#ff0055"></a-light>
      <a-light type="ambient" intensity="0.5"></a-light>

      <a-entity mindar-image-target="targetIndex: 0">
        
        <a-entity id="effect-plane" visible="false" position="0 0 -0.1">
            <a-ring color="red" radius-inner="0.5" radius-outer="0.55"></a-ring>
            <a-ring color="cyan" radius-inner="0.8" radius-outer="0.85"></a-ring>
            <a-entity rotation="0 0 0"><a-plane color="white" height="2" width="0.02"></a-plane></a-entity>
            <a-entity rotation="0 0 45"><a-plane color="white" height="2" width="0.02"></a-plane></a-entity>
            <a-entity rotation="0 0 90"><a-plane color="white" height="2" width="0.02"></a-plane></a-entity>
            <a-entity rotation="0 0 135"><a-plane color="white" height="2" width="0.02"></a-plane></a-entity>
        </a-entity>
        
        <a-entity id="band-model" 
                  gltf-model="#modelAsset" 
                  rotation="0 45 180" 
                  position="0 0 0" 
                  visible="false">
        </a-entity>
        
      </a-entity>
    </a-scene>
  </body>
</html>