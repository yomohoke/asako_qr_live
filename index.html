<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    
    <style>
      body { margin: 0; overflow: hidden; background-color: #000; }
      
      /* 全画面オーバーレイ（暗転とフラッシュ用） */
      #screen-effect {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: black; z-index: 999; pointer-events: none; opacity: 1;
        transition: opacity 0.5s ease;
      }

      /* スタートボタン */
      #overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        display: flex; justify-content: center; align-items: center;
        z-index: 1000; background: black;
      }
      #start-btn {
        padding: 20px 40px; border: 2px solid #fff; background: none;
        color: white; font-size: 1.2rem; cursor: pointer; letter-spacing: 0.3em;
      }
    </style>

    <script>
      // 1. オーディオ解析（音量データを全体に共有）
      AFRAME.registerSystem('audio-system', {
        init: function () { this.bass = 0; this.analyser = null; },
        setup: function (audio) {
          const ctx = new (window.AudioContext || window.webkitAudioContext)();
          const src = ctx.createMediaElementSource(audio);
          this.analyser = ctx.createAnalyser();
          this.analyser.fftSize = 256;
          src.connect(this.analyser);
          this.analyser.connect(ctx.destination);
          this.data = new Uint8Array(this.analyser.frequencyBinCount);
        },
        tick: function () {
          if (!this.analyser) return;
          this.analyser.getByteFrequencyData(this.data);
          let sum = 0;
          for (let i = 0; i < 10; i++) sum += this.data[i];
          this.bass = sum / 10 / 255; // 0.0 ~ 1.0
          
          // 強い低音でバイブレーション
          if (this.bass > 0.7 && Math.random() > 0.8) {
            if (navigator.vibrate) navigator.vibrate(30);
          }
        }
      });

      // 2. ライブ演出全体をコントロールするマネージャー
      AFRAME.registerComponent('live-manager', {
        init: function () {
          const el = this.el;
          const audio = document.querySelector('#bgm');
          const effect = document.querySelector('#screen-effect');

          // マーカーを認識した時の処理
          el.addEventListener('targetFound', () => {
            console.log("Marker Found: Starting Live!");
            
            // 音楽再生
            audio.play();

            // 画面を一瞬白くして（フラッシュ）、暗転を解除
            effect.style.transition = 'none';
            effect.style.backgroundColor = 'white';
            effect.style.opacity = '1';
            
            setTimeout(() => {
              effect.style.transition = 'opacity 2s ease';
              effect.style.backgroundColor = 'black';
              effect.style.opacity = '0'; // 徐々にARが見えてくる
            }, 50);

            // モデルの「にゅっ」というアニメーションを開始
            const model = document.querySelector('#main-model');
            model.setAttribute('animation', {
              property: 'scale',
              from: '0 0 0',
              to: '1 1 1',
              dur: 1500,
              easing: 'easeOutElastic'
            });
          });

          // マーカーを見失った時は音楽を止める（任意）
          el.addEventListener('targetLost', () => {
            audio.pause();
          });
        }
      });

      // 3. カメラシェイク
      AFRAME.registerComponent('cam-shaker', {
        tick: function () {
          const bass = this.el.sceneEl.systems['audio-system'].bass;
          if (bass > 0.5) {
            const intensity = (bass - 0.5) * 0.2;
            this.el.setAttribute('position', {
              x: (Math.random() - 0.5) * intensity,
              y: (Math.random() - 0.5) * intensity + 1.6,
              z: (Math.random() - 0.5) * intensity
            });
          }
        }
      });

      // スタートボタンの処理
      function startExperience() {
        document.querySelector('#overlay').style.display = 'none';
        const audio = document.querySelector('#bgm');
        // iOS対策：ここでAudioContextを初期化
        document.querySelector('a-scene').systems['audio-system'].setup(audio);
        // カメラ起動のために一瞬だけ画面を明るく（スキャンしやすくする）
        document.querySelector('#screen-effect').style.opacity = '0.5';
      }
    </script>
  </head>

  <body>
    <div id="screen-effect"></div>
    
    <div id="overlay">
      <button id="start-btn" onclick="startExperience()">SCAN THE NEWSPAPER</button>
    </div>

    <a-scene 
      mindar-image="imageTargetSrc: ./targets.mind;" 
      renderer="colorManagement: true, physicallyCorrectLights: true"
      vr-mode-ui="enabled: false">
      
      <a-assets>
        <a-asset-item id="gltfModel" src="./scene.gltf"></a-asset-item>
        <audio id="bgm" src="./music.m4a" preload="auto" loop></audio>
      </a-assets>

      <a-camera position="0 1.6 0" look-controls="enabled: false" cam-shaker></a-camera>

      <a-entity mindar-image-target="targetIndex: 0" live-manager>
        
        <a-entity 
          geometry="primitive: torus; radius: 1; radiusTubular: 0.05" 
          material="color: #0ff; wireframe: true"
          position="0 0 -0.5"
          scale="1 1 1"
          animation="property: rotation; to: 0 360 0; loop: true; dur: 4000; easing: linear">
        </a-entity>

        <a-gltf-model 
          id="main-model"
          src="#gltfModel" 
          scale="0 0 0" 
          position="0 -0.3 0" 
          rotation="90 0 0">
        </a-gltf-model>

      </a-entity>
    </a-scene>
  </body>
</html>