<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    
    <script>
      // ▼ 紙面を歪ませるシェーダー（画像テクスチャ対応・グリッドなし）
      AFRAME.registerComponent('distorted-paper', {
        schema: {
          src: {type: 'map'}, // 画像を受け取る設定
        },
        init: function () {
          this.audioLevel = 0;

          // 1. 平面を作成
          const geometry = new THREE.PlaneGeometry(1, 1, 64, 64); 
          
          // 2. 画像をテクスチャとして読み込み
          // A-Frameのシステム経由で画像を取得
          const texture = new THREE.TextureLoader().load(this.data.src.src); 
          
          const material = new THREE.ShaderMaterial({
            wireframe: false, // ★ここでグリッドを消す！
            transparent: true,
            uniforms: {
              uTime: { value: 0 },
              uAudio: { value: 0.0 },
              uTexture: { value: texture } // シェーダーに画像を渡す
            },
            vertexShader: `
              varying vec2 vUv;
              uniform float uTime;
              uniform float uAudio;

              void main() {
                vUv = uv;
                vec3 pos = position;
                
                // 中心からの距離
                float d = distance(uv, vec2(0.5));
                
                // 音に合わせて波打つ（Z軸方向）
                // 紙の端っこ(d>0.4)は揺らさないことで、現実の紙と馴染ませる
                float mask = smoothstep(0.5, 0.2, d); 
                
                float wave = sin(pos.x * 12.0 + uTime * 5.0) * cos(pos.y * 12.0 + uTime * 4.0);
                
                // 音量(uAudio)に応じて揺れ幅を変える
                pos.z += wave * uAudio * 0.4 * mask; 
                
                gl_Position = projectionMatrix * modelViewMatrix * vec4(pos, 1.0);
              }
            `,
            fragmentShader: `
              varying vec2 vUv;
              uniform sampler2D uTexture;
              uniform float uAudio;
              
              void main() {
                // 画像の色をそのまま表示
                vec4 color = texture2D(uTexture, vUv);
                
                // 音に合わせて少し明るくする（発光演出）
                color.rgb += uAudio * 0.15;
                
                gl_FragColor = color;
              }
            `
          });
          
          this.mesh = new THREE.Mesh(geometry, material);
          this.el.setObject3D('mesh', this.mesh);
        },
        
        tick: function (time, timeDelta) {
          if (!this.mesh) return;
          this.mesh.material.uniforms.uTime.value = time / 1000;
          this.mesh.material.uniforms.uAudio.value += (this.audioLevel - this.mesh.material.uniforms.uAudio.value) * 0.1;
        },

        updateAudioLevel: function(level) {
            this.audioLevel = level;
        }
      });

      // ▼ コントローラー（タップ→出現→再生）
      AFRAME.registerComponent('live-controller', {
        init: function () {
            this.audioEl = document.querySelector('#bgm');
            this.model = document.querySelector('#band-model');
            this.paper = document.querySelector('#paper-plane');
            this.startBtn = document.querySelector('#start-button');
            this.isPlaying = false;
            
            this.startBtn.addEventListener('click', () => {
                this.startSequence();
            });

            const scene = document.querySelector('a-scene');
            scene.addEventListener("targetFound", () => {
                if(!this.isPlaying) {
                    this.startBtn.style.display = 'block';
                    this.startBtn.innerText = "TAP TO START LIVE";
                }
            });
            scene.addEventListener("targetLost", () => {
                this.startBtn.style.display = 'none';
                if(this.isPlaying) this.audioEl.pause();
            });
        },

        startSequence: function() {
            this.isPlaying = true;
            this.startBtn.style.display = 'none';

            // 1. モデルを表示
            this.model.setAttribute('visible', true);
            
            // 2. 拡大アニメーション (0 -> 1.0)
            // ※モデルサイズが大きすぎる場合は if (scale >= 0.5) とかにしてください
            let scale = 0;
            const grow = setInterval(() => {
                scale += 0.05; 
                this.model.setAttribute('scale', `${scale} ${scale} ${scale}`);
                if (scale >= 1.0) { 
                    clearInterval(grow);
                    this.startMusic();
                }
            }, 30);
        },

        startMusic: function() {
            this.audioEl.play();
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            const ctx = new AudioContext();
            const src = ctx.createMediaElementSource(this.audioEl);
            const analyser = ctx.createAnalyser();
            analyser.fftSize = 256;
            src.connect(analyser);
            analyser.connect(ctx.destination);
            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            
            const loop = () => {
                requestAnimationFrame(loop);
                analyser.getByteFrequencyData(dataArray);
                let sum = 0;
                for(let i=0; i<10; i++) sum += dataArray[i];
                let avg = sum / 10 / 255;
                
                this.paper.components['distorted-paper'].updateAudioLevel(avg);
                if (avg > 0.6 && navigator.vibrate) navigator.vibrate(50);
            };
            loop();
        }
      });
    </script>

    <style>
      body { margin: 0; overflow: hidden; }
      #start-button {
        position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%);
        padding: 12px 24px; background: rgba(0,0,0,0.8); color: white; border: 1px solid white; 
        font-family: sans-serif; letter-spacing: 1px; border-radius: 4px;
        display: none; z-index: 999; cursor: pointer;
      }
    </style>
  </head>
  <body>
    <button id="start-button">SCANNING...</button>

    <a-scene 
      mindar-image="imageTargetSrc: ./targets.mind; uiScanning: no; filterMinCF:0.0001; filterBeta: 0.001;" 
      color-space="sRGB" 
      renderer="colorManagement: true, physicallyCorrectLights" 
      vr-mode-ui="enabled: false" 
      device-orientation-permission-ui="enabled: false">
      
      <a-assets>
        <a-asset-item id="modelAsset" src="./scene.gltf"></a-asset-item>
        <audio id="bgm" src="./music.m4a" preload="auto" crossorigin="anonymous"></audio>
        
        <img id="paperTex" src="./asako_qr_1.png" />
      </a-assets>

      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
      <a-entity live-controller></a-entity>

      <a-light type="ambient" intensity="1.2"></a-light>
      <a-light type="directional" intensity="1.5" position="2 4 2"></a-light>

      <a-entity mindar-image-target="targetIndex: 0">
        
        <a-entity id="paper-plane" distorted-paper="src: #paperTex" position="0 0 0.01"></a-entity>
        
        <a-entity id="band-model" 
                  gltf-model="#modelAsset" 
                  rotation="0 45 180" 
                  position="0 0 0" 
                  scale="0 0 0"
                  visible="false">
        </a-entity>
        
      </a-entity>
    </a-scene>
  </body>
</html>