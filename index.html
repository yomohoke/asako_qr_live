<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>LIVE AR EXPERIENCE</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    
    <style>
      body { margin: 0; overflow: hidden; font-family: sans-serif; }
      
      /* ▼ MindARの標準ローディング画面をCSSで強制的に消す（これが諸悪の根源） */
      .mindar-ui-loading, .mindar-ui-scanning {
        display: none !important;
      }

      /* スタート画面 */
      #overlay {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: black; z-index: 99999;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        color: white; text-align: center;
      }
      #enter-btn {
        padding: 15px 40px; font-size: 18px; font-weight: bold; letter-spacing: 2px;
        background: white; color: black; border: none; cursor: pointer; margin-top: 20px;
        text-transform: uppercase;
      }
      
      /* デバッグログ */
      #debug-log {
        position: absolute; top: 10px; left: 10px; color: #00ff00; z-index: 1000;
        background: rgba(0,0,0,0.7); padding: 5px; pointer-events: none;
        font-size: 12px; font-family: monospace;
      }
    </style>

    <script>
      function log(text) {
        const el = document.getElementById('debug-log');
        if(el) el.innerHTML = text;
        console.log(text);
      }

      // ▼ 画質向上コンポーネント（Retina対応）
      AFRAME.registerComponent('high-quality', {
        init: function () {
            // シーンのレンダラーを取得
            const scene = this.el.sceneEl;
            // ピクセル比をデバイスの最大値に合わせる（これでiPhoneでもクッキリする）
            scene.renderer.setPixelRatio(window.devicePixelRatio);
            scene.renderer.antialias = true;
            log("High Quality Mode: ON ✨");
        }
      });

      // ▼ 紙面シェーダー
      AFRAME.registerComponent('distorted-paper', {
        schema: { src: {type: 'map'} },
        init: function () {
          // 見開き比率 1 : 0.67
          const geometry = new THREE.PlaneGeometry(1, 0.67, 64, 64); 
          const texture = new THREE.TextureLoader().load(this.data.src.src); 
          // テクスチャの画質設定（ボヤけ防止）
          texture.minFilter = THREE.LinearFilter;
          texture.magFilter = THREE.LinearFilter;
          texture.anisotropy = 16; // 異方性フィルタリング最大

          const material = new THREE.ShaderMaterial({
            wireframe: false,
            transparent: true,
            uniforms: {
              uTime: { value: 0 },
              uAudio: { value: 0.0 },
              uTexture: { value: texture }
            },
            vertexShader: `
              varying vec2 vUv;
              uniform float uTime;
              uniform float uAudio;
              void main() {
                vUv = uv;
                vec3 pos = position;
                float d = distance(uv, vec2(0.5));
                float mask = smoothstep(0.5, 0.1, d); 
                float wave = sin(pos.x * 12.0 + uTime * 6.0) * cos(pos.y * 12.0 + uTime * 5.0);
                pos.z += wave * uAudio * 0.3 * mask; 
                gl_Position = projectionMatrix * modelViewMatrix * vec4(pos, 1.0);
              }
            `,
            fragmentShader: `
              varying vec2 vUv;
              uniform sampler2D uTexture;
              uniform float uAudio;
              void main() {
                vec4 color = texture2D(uTexture, vUv);
                color.rgb += uAudio * 0.3;
                gl_FragColor = color;
              }
            `
          });
          this.mesh = new THREE.Mesh(geometry, material);
          this.el.setObject3D('mesh', this.mesh);
        },
        tick: function (time, timeDelta) {
          if (!this.mesh) return;
          this.mesh.material.uniforms.uTime.value = time / 1000;
          this.mesh.material.uniforms.uAudio.value = window.currentAudioLevel || 0;
        }
      });

      // ▼ アプリ制御
      AFRAME.registerComponent('app-controller', {
        init: function () {
            this.audioEl = document.querySelector('#bgm');
            this.model = document.querySelector('#band-model');
            this.hasStarted = false;

            const scene = document.querySelector('a-scene');
            
            // MindARの準備ができたらグルグルを消す
            scene.addEventListener("arReady", () => {
                log("Camera Ready. Waiting for UI...");
            });

            scene.addEventListener("targetFound", () => {
                if (!window.isAudioUnlocked) {
                    log("Please TAP BUTTON first!");
                    return;
                }
                if (!this.hasStarted) {
                    this.startShow();
                }
            });
            
            scene.addEventListener("targetLost", () => {
                 if(this.hasStarted) log("Target Lost (Music playing)");
            });
        },

        startShow: function() {
            this.hasStarted = true;
            log("Target Found! STARTING...");
            
            this.audioEl.play();
            
            this.model.setAttribute('visible', true);
            let s = 0;
            const timer = setInterval(() => {
                s += 0.05;
                this.model.setAttribute('scale', `${s} ${s} ${s}`);
                if (s >= 1.0) clearInterval(timer);
            }, 30);

            this.analyzeAudio();
        },

        analyzeAudio: function() {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const src = ctx.createMediaElementSource(this.audioEl);
            const analyser = ctx.createAnalyser();
            analyser.fftSize = 256;
            src.connect(analyser);
            analyser.connect(ctx.destination);
            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            
            const loop = () => {
                requestAnimationFrame(loop);
                analyser.getByteFrequencyData(dataArray);
                let sum = 0;
                for(let i=0; i<8; i++) sum += dataArray[i];
                window.currentAudioLevel = (sum / 8 / 255); 
            };
            loop();
        }
      });

      window.onload = () => {
        const btn = document.getElementById('enter-btn');
        btn.addEventListener('click', () => {
            // 音声ロック解除
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            ctx.resume().then(() => {
                window.isAudioUnlocked = true;
                document.getElementById('overlay').style.display = 'none';
                log("Ready! Scan the newspaper!");
            });
        });
      };
    </script>
  </head>
  <body>

    <div id="overlay">
        <h1>LIVE AR</h1>
        <p>Turn up volume</p>
        <button id="enter-btn">START CAMERA</button>
    </div>
    <div id="debug-log">Initializing...</div>

    <a-scene 
      high-quality
      mindar-image="imageTargetSrc: ./targets.mind; uiLoading: no; uiScanning: no; filterMinCF:0.0001; filterBeta: 0.001;" 
      color-space="sRGB" 
      renderer="colorManagement: true, physicallyCorrectLights: true; antialias: true; alpha: true;" 
      vr-mode-ui="enabled: false" 
      device-orientation-permission-ui="enabled: false">
      
      <a-assets>
        <a-asset-item id="modelAsset" src="./scene.gltf"></a-asset-item>
        <audio id="bgm" src="./music.m4a" preload="auto" crossorigin="anonymous"></audio>
        <img id="paperTex" src="./asako_qr_1.png" />
      </a-assets>

      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
      
      <a-entity app-controller></a-entity>

      <a-light type="ambient" intensity="0.8"></a-light>
      <a-light type="directional" intensity="2" position="2 4 5" color="#ffaa00"></a-light>
      <a-light type="spot" intensity="5" position="0 5 0" angle="45" penumbra="0.5" color="#ff0000"></a-light>

      <a-entity mindar-image-target="targetIndex: 0">
        
        <a-entity distorted-paper="src: #paperTex" position="0 0 0.01"></a-entity>
        
        <a-entity id="band-model" 
                  gltf-model="#modelAsset" 
                  rotation="0 45 180" 
                  position="0 0 0" 
                  scale="0 0 0" 
                  visible="false">
        </a-entity>
        
      </a-entity>
    </a-scene>
  </body>
</html>